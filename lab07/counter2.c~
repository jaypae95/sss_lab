/* ----------------------------------------------------------------------------------------------------
 *  파일: counter2.c
 *  기능	: 경쟁조건이 발생하지 않는 동기화 된 counting 프로그램
 *  개발자: 201520934 배재훈
 *  날짜	: 1차 개발 : 2018년 5월 4일 
 *----------------------------------------------------------------------------------------------------*/
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <stdlib.h>
void *counter(void *arg);
int cnt = 0;

pthread_mutex_t sync_mutex;

int main() {
		pthread_t tid[5];
		pthread_mutex_init(&sync_mutex, NULL);
		int i;
		for(i = 0; i<5; i++) {
				if(pthread_create(&tid[i], NULL, counter,  NULL) != 0) {
						printf("fail to create thread.\n");
						return 0;
						}
		}
		for(i = 0; i<5; i++) {
				if(pthread_join(tid[i], NULL) != 0) {
						printf("fail to join thread.\n");
						return 0;
				}
		}
		return 0;
}

void *counter(void *args) {

		int tmp, j;
		pthread_mutex_lock(&sync_mutex);
		for(j=0; j<10; j++) {
				tmp = cnt;
				usleep(1);
				tmp++;
				cnt = tmp;
				printf("%d\n", cnt);
		}
		pthread_mutex_unlock(&sync_mutex);
		pthread_exit((void*)0);
}				
